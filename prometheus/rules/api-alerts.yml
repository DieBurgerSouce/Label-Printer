# API Alert Rules
# Enterprise-grade alerting for Screenshot_Algo API endpoints

groups:
  - name: api-alerts
    interval: 30s
    rules:
      # ========================================================================
      # Availability Alerts
      # ========================================================================
      - alert: ServiceDown
        expr: up{job="screenshot-algo"} == 0
        for: 1m
        labels:
          severity: critical
          team: backend
          component: api
        annotations:
          summary: "Screenshot_Algo service is down"
          description: "The Screenshot_Algo API has been unreachable for more than 1 minute."
          runbook_url: "https://docs.screenshot-algo.com/runbooks/service-down"
          dashboard_url: "https://grafana.screenshot-algo.com/d/api-overview"

      - alert: HealthCheckFailing
        expr: screenshot_health_check_status == 0
        for: 2m
        labels:
          severity: critical
          team: backend
          component: api
        annotations:
          summary: "Health check is failing"
          description: "The /health endpoint has been returning errors for more than 2 minutes."
          runbook_url: "https://docs.screenshot-algo.com/runbooks/health-check"

      # ========================================================================
      # Error Rate Alerts
      # ========================================================================
      - alert: HighErrorRate
        expr: |
          (
            sum(rate(http_requests_total{job="screenshot-algo",status=~"5.."}[5m]))
            /
            sum(rate(http_requests_total{job="screenshot-algo"}[5m]))
          ) > 0.05
        for: 5m
        labels:
          severity: critical
          team: backend
          component: api
        annotations:
          summary: "High error rate detected"
          description: "Error rate is above 5% (current: {{ $value | humanizePercentage }})"
          runbook_url: "https://docs.screenshot-algo.com/runbooks/high-error-rate"

      - alert: ElevatedErrorRate
        expr: |
          (
            sum(rate(http_requests_total{job="screenshot-algo",status=~"5.."}[5m]))
            /
            sum(rate(http_requests_total{job="screenshot-algo"}[5m]))
          ) > 0.01
        for: 10m
        labels:
          severity: warning
          team: backend
          component: api
        annotations:
          summary: "Elevated error rate"
          description: "Error rate is above 1% (current: {{ $value | humanizePercentage }})"

      - alert: High4xxRate
        expr: |
          (
            sum(rate(http_requests_total{job="screenshot-algo",status=~"4.."}[5m]))
            /
            sum(rate(http_requests_total{job="screenshot-algo"}[5m]))
          ) > 0.10
        for: 10m
        labels:
          severity: warning
          team: backend
          component: api
        annotations:
          summary: "High 4xx error rate"
          description: "Client error rate is above 10% (current: {{ $value | humanizePercentage }})"

      # ========================================================================
      # Latency Alerts
      # ========================================================================
      - alert: HighLatencyP95
        expr: |
          histogram_quantile(0.95,
            sum(rate(http_request_duration_seconds_bucket{job="screenshot-algo"}[5m])) by (le)
          ) > 5
        for: 5m
        labels:
          severity: warning
          team: backend
          component: api
        annotations:
          summary: "High request latency (P95)"
          description: "95th percentile latency is above 5 seconds (current: {{ $value | humanizeDuration }})"

      - alert: CriticalLatencyP99
        expr: |
          histogram_quantile(0.99,
            sum(rate(http_request_duration_seconds_bucket{job="screenshot-algo"}[5m])) by (le)
          ) > 10
        for: 5m
        labels:
          severity: critical
          team: backend
          component: api
        annotations:
          summary: "Critical request latency (P99)"
          description: "99th percentile latency is above 10 seconds (current: {{ $value | humanizeDuration }})"

      - alert: SlowEndpoint
        expr: |
          histogram_quantile(0.95,
            sum(rate(http_request_duration_seconds_bucket{job="screenshot-algo"}[5m])) by (le, handler)
          ) > 3
        for: 10m
        labels:
          severity: warning
          team: backend
          component: api
        annotations:
          summary: "Slow endpoint detected"
          description: "Endpoint {{ $labels.handler }} has P95 latency above 3 seconds"

      # ========================================================================
      # Throughput Alerts
      # ========================================================================
      - alert: LowRequestRate
        expr: |
          sum(rate(http_requests_total{job="screenshot-algo"}[5m])) < 0.1
        for: 15m
        labels:
          severity: warning
          team: backend
          component: api
        annotations:
          summary: "Unusually low request rate"
          description: "Request rate is below 0.1 req/s for 15 minutes. Possible traffic issue."

      - alert: HighRequestRate
        expr: |
          sum(rate(http_requests_total{job="screenshot-algo"}[1m])) > 1000
        for: 5m
        labels:
          severity: warning
          team: backend
          component: api
        annotations:
          summary: "High request rate"
          description: "Request rate is above 1000 req/s. Consider scaling."

      # ========================================================================
      # Rate Limiting Alerts
      # ========================================================================
      - alert: RateLimitTriggered
        expr: |
          sum(rate(http_requests_total{job="screenshot-algo",status="429"}[5m])) > 1
        for: 5m
        labels:
          severity: warning
          team: backend
          component: api
        annotations:
          summary: "Rate limiting is active"
          description: "Rate limiting is being triggered frequently"

      # ========================================================================
      # Connection Alerts
      # ========================================================================
      - alert: HighActiveConnections
        expr: |
          http_active_connections{job="screenshot-algo"} > 500
        for: 5m
        labels:
          severity: warning
          team: backend
          component: api
        annotations:
          summary: "High number of active connections"
          description: "Active connections: {{ $value }}. Consider increasing capacity."
