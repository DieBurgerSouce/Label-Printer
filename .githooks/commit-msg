#!/bin/bash
# Commit Message Hook for Screenshot_Algo
# Validates commit message format (Conventional Commits)
#
# Install: git config core.hooksPath .githooks
# Or: make hooks-install

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

echo -e "Validating commit message..."

# Conventional Commits pattern
# type(scope): description
# type: description
PATTERN="^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert|wip)(\([a-zA-Z0-9_/-]+\))?(!)?: .{1,100}$"

# Allow merge commits
if echo "$COMMIT_MSG" | head -1 | grep -qE "^Merge "; then
    echo -e "${GREEN}✓${NC} Merge commit accepted"
    exit 0
fi

# Allow revert commits
if echo "$COMMIT_MSG" | head -1 | grep -qE "^Revert "; then
    echo -e "${GREEN}✓${NC} Revert commit accepted"
    exit 0
fi

# Allow squash commits
if echo "$COMMIT_MSG" | head -1 | grep -qE "^Squash"; then
    echo -e "${GREEN}✓${NC} Squash commit accepted"
    exit 0
fi

# Allow fixup commits
if echo "$COMMIT_MSG" | head -1 | grep -qE "^fixup!"; then
    echo -e "${GREEN}✓${NC} Fixup commit accepted"
    exit 0
fi

# Check first line
FIRST_LINE=$(echo "$COMMIT_MSG" | head -1)

if echo "$FIRST_LINE" | grep -qE "$PATTERN"; then
    echo -e "${GREEN}✓${NC} Commit message format valid"

    # Additional checks for good messages

    # Check minimum length
    MSG_LENGTH=${#FIRST_LINE}
    if [ $MSG_LENGTH -lt 10 ]; then
        echo -e "${YELLOW}!${NC} Commit message is very short"
    fi

    # Check for capital letter after type
    if echo "$FIRST_LINE" | grep -qE ": [a-z]"; then
        : # lowercase is fine
    fi

    # Check for period at the end (not recommended)
    if echo "$FIRST_LINE" | grep -qE "\.$"; then
        echo -e "${YELLOW}!${NC} Avoid trailing period in commit message"
    fi

    exit 0
else
    echo -e "${RED}✗${NC} Invalid commit message format"
    echo ""
    echo -e "${YELLOW}Expected format:${NC} type(scope): description"
    echo ""
    echo -e "${YELLOW}Types:${NC}"
    echo "  feat     - A new feature"
    echo "  fix      - A bug fix"
    echo "  docs     - Documentation only changes"
    echo "  style    - Formatting, missing semicolons, etc."
    echo "  refactor - Code change that neither fixes a bug nor adds a feature"
    echo "  test     - Adding missing tests"
    echo "  chore    - Maintenance tasks"
    echo "  perf     - Performance improvements"
    echo "  ci       - CI/CD changes"
    echo "  build    - Build system changes"
    echo "  revert   - Revert previous commit"
    echo "  wip      - Work in progress (for feature branches)"
    echo ""
    echo -e "${YELLOW}Examples:${NC}"
    echo "  feat(api): add screenshot endpoint"
    echo "  fix(worker): resolve memory leak"
    echo "  docs: update API documentation"
    echo "  test(e2e): add browser compatibility tests"
    echo "  chore(deps): update dependencies"
    echo "  feat!: breaking change in API"
    echo ""
    echo -e "${YELLOW}Your message:${NC} $FIRST_LINE"
    echo ""
    echo -e "${YELLOW}Use 'git commit --no-verify' to bypass (not recommended)${NC}"
    exit 1
fi
