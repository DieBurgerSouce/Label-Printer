#!/bin/bash
# Pre-commit Hook for Screenshot_Algo
# Runs before each commit to ensure code quality
#
# Install: git config core.hooksPath .githooks
# Or: make hooks-install

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}  Pre-Commit Checks (Screenshot_Algo)${NC}"
echo -e "${BLUE}========================================${NC}"

# Get project root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

cd "$PROJECT_ROOT"

# Track failures
FAILED=0
WARNINGS=0

# ============================================
# 1. Check for staged files
# ============================================
STAGED_JS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx)$' || true)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${YELLOW}No files staged, nothing to check${NC}"
    exit 0
fi

echo -e "\n${BLUE}Staged files:${NC}"
echo "$STAGED_FILES" | head -20 | sed 's/^/  - /'
if [ $(echo "$STAGED_FILES" | wc -l) -gt 20 ]; then
    echo -e "  ... and $(( $(echo "$STAGED_FILES" | wc -l) - 20 )) more"
fi

# ============================================
# 2. Run ESLint on staged JS/TS files
# ============================================
if [ -n "$STAGED_JS_FILES" ]; then
    echo -e "\n${BLUE}1. Running ESLint...${NC}"

    if npm run lint --if-present --silent 2>/dev/null; then
        echo -e "${GREEN}âœ“${NC} ESLint passed"
    else
        echo -e "${RED}âœ—${NC} ESLint failed"
        echo -e "${YELLOW}ðŸ’¡ Run: npm run lint -- --fix${NC}"
        FAILED=1
    fi
else
    echo -e "\n${BLUE}1. ESLint: ${YELLOW}No JS/TS files staged, skipping${NC}"
fi

# ============================================
# 3. Run TypeScript type checking
# ============================================
if [ -n "$STAGED_JS_FILES" ]; then
    echo -e "\n${BLUE}2. Running TypeScript check...${NC}"

    if npx tsc --noEmit 2>/dev/null; then
        echo -e "${GREEN}âœ“${NC} TypeScript passed"
    else
        echo -e "${RED}âœ—${NC} TypeScript errors found"
        echo -e "${YELLOW}ðŸ’¡ Run: npx tsc --noEmit${NC}"
        FAILED=1
    fi
else
    echo -e "\n${BLUE}2. TypeScript: ${YELLOW}No TS files staged, skipping${NC}"
fi

# ============================================
# 4. Check for secrets in staged files
# ============================================
echo -e "\n${BLUE}3. Checking for secrets...${NC}"

SECRET_PATTERNS="password=|PASSWORD=|api_key=|API_KEY=|apikey=|secret=|SECRET=|token=|TOKEN=|private_key|PRIVATE_KEY"
FOUND_SECRETS=0

for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        # Skip allowed files
        if [[ "$file" == *".env.example"* ]] || \
           [[ "$file" == *".env.production.example"* ]] || \
           [[ "$file" == *".md"* ]] || \
           [[ "$file" == *".githooks"* ]] || \
           [[ "$file" == *"secrets.baseline"* ]]; then
            continue
        fi

        if git show ":$file" 2>/dev/null | grep -iE "$SECRET_PATTERNS" | grep -vE "^#|^//|your-|example|placeholder|process\.env\.|getenv|os\.environ" > /dev/null 2>&1; then
            echo -e "${RED}âœ—${NC} Potential secret found in: $file"
            FOUND_SECRETS=1
        fi
    fi
done

if [ $FOUND_SECRETS -eq 0 ]; then
    echo -e "${GREEN}âœ“${NC} No secrets detected"
else
    echo -e "${RED}âœ—${NC} Potential secrets found - please review"
    echo -e "${YELLOW}ðŸ’¡ Use environment variables for sensitive data${NC}"
    FAILED=1
fi

# ============================================
# 5. Check for debugging statements
# ============================================
echo -e "\n${BLUE}4. Checking for debug statements...${NC}"
DEBUG_FOUND=0

for file in $(echo "$STAGED_JS_FILES" | head -50); do
    if [ -f "$file" ]; then
        # Check for console.log, debugger, etc.
        if git show ":$file" 2>/dev/null | grep -E "console\.(log|debug|info)|debugger" | grep -v "// eslint-disable" | grep -v "// ok" > /dev/null 2>&1; then
            echo -e "${YELLOW}!${NC} Debug statement in: $file"
            DEBUG_FOUND=1
        fi
    fi
done

if [ $DEBUG_FOUND -eq 0 ]; then
    echo -e "${GREEN}âœ“${NC} No debug statements"
else
    echo -e "${YELLOW}!${NC} Debug statements found (warning only)"
    WARNINGS=$((WARNINGS + 1))
fi

# ============================================
# 6. Check file sizes
# ============================================
echo -e "\n${BLUE}5. Checking file sizes...${NC}"
MAX_SIZE=500000  # 500KB
LARGE_FILES=0

for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        SIZE=$(wc -c < "$file" 2>/dev/null || echo 0)
        if [ "$SIZE" -gt "$MAX_SIZE" ]; then
            SIZE_KB=$((SIZE / 1024))
            echo -e "${YELLOW}!${NC} Large file (${SIZE_KB}KB): $file"
            LARGE_FILES=1
        fi
    fi
done

if [ $LARGE_FILES -eq 0 ]; then
    echo -e "${GREEN}âœ“${NC} File sizes OK"
else
    echo -e "${YELLOW}!${NC} Large files detected (warning only)"
    WARNINGS=$((WARNINGS + 1))
fi

# ============================================
# 7. Check for TODO/FIXME markers
# ============================================
echo -e "\n${BLUE}6. Checking for TODOs...${NC}"
TODO_COUNT=0

for file in $(echo "$STAGED_JS_FILES" | head -50); do
    if [ -f "$file" ]; then
        count=$(git show ":$file" 2>/dev/null | grep -cE "TODO:|FIXME:|XXX:|HACK:" || true)
        TODO_COUNT=$((TODO_COUNT + count))
    fi
done

if [ $TODO_COUNT -gt 0 ]; then
    echo -e "${YELLOW}!${NC} Found $TODO_COUNT TODO/FIXME markers"
    WARNINGS=$((WARNINGS + 1))
else
    echo -e "${GREEN}âœ“${NC} No TODO markers"
fi

# ============================================
# 8. Check package-lock.json consistency
# ============================================
echo -e "\n${BLUE}7. Checking package-lock.json...${NC}"

if echo "$STAGED_FILES" | grep -q "package.json"; then
    if ! echo "$STAGED_FILES" | grep -q "package-lock.json"; then
        echo -e "${YELLOW}!${NC} package.json changed but package-lock.json not staged"
        echo -e "${YELLOW}ðŸ’¡ Run: npm install && git add package-lock.json${NC}"
        WARNINGS=$((WARNINGS + 1))
    else
        echo -e "${GREEN}âœ“${NC} package-lock.json synchronized"
    fi
else
    echo -e "${GREEN}âœ“${NC} No package.json changes"
fi

# ============================================
# Summary
# ============================================
echo -e "\n${BLUE}========================================${NC}"
if [ $FAILED -eq 0 ]; then
    if [ $WARNINGS -gt 0 ]; then
        echo -e "${GREEN}Pre-commit checks passed${NC} (with ${YELLOW}$WARNINGS warning(s)${NC})"
    else
        echo -e "${GREEN}All pre-commit checks passed!${NC}"
    fi
    exit 0
else
    echo -e "${RED}Pre-commit checks failed - please fix issues${NC}"
    echo -e "${YELLOW}Use 'git commit --no-verify' to bypass (not recommended)${NC}"
    exit 1
fi
