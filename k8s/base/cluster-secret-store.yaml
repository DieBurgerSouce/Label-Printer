# ClusterSecretStore Configuration
# Defines how External Secrets Operator connects to secret backends
#
# Prerequisites:
# 1. External Secrets Operator installed:
#    helm repo add external-secrets https://charts.external-secrets.io
#    helm install external-secrets external-secrets/external-secrets -n external-secrets --create-namespace
#
# 2. AWS Secrets Manager access configured via IRSA or instance profile
#
# For other providers, see:
# - HashiCorp Vault: https://external-secrets.io/latest/provider/hashicorp-vault/
# - GCP Secret Manager: https://external-secrets.io/latest/provider/google-secrets-manager/
# - Azure Key Vault: https://external-secrets.io/latest/provider/azure-key-vault/
---
# AWS Secrets Manager SecretStore (recommended for AWS deployments)
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: aws-secrets-manager
  labels:
    app.kubernetes.io/name: screenshot-algo
    app.kubernetes.io/component: secret-store
spec:
  provider:
    aws:
      service: SecretsManager
      region: eu-central-1
      # Authentication via IRSA (IAM Roles for Service Accounts)
      # Requires: eks.amazonaws.com/role-arn annotation on ServiceAccount
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets
            namespace: external-secrets
---
# Alternative: HashiCorp Vault SecretStore
# Uncomment and configure if using Vault instead of AWS Secrets Manager
# apiVersion: external-secrets.io/v1beta1
# kind: ClusterSecretStore
# metadata:
#   name: vault
#   labels:
#     app.kubernetes.io/name: screenshot-algo
#     app.kubernetes.io/component: secret-store
# spec:
#   provider:
#     vault:
#       server: "https://vault.example.com"
#       path: "secret"
#       version: "v2"
#       auth:
#         kubernetes:
#           mountPath: "kubernetes"
#           role: "screenshot-algo"
#           serviceAccountRef:
#             name: external-secrets
#             namespace: external-secrets
---
# ServiceAccount for External Secrets (with IRSA annotation)
apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-secrets
  namespace: external-secrets
  annotations:
    # Replace with your actual IAM role ARN
    # Create role with: SecretsManagerReadWrite policy scoped to screenshot-algo/*
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/screenshot-algo-external-secrets
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: service-account
---
# IAM Policy Template (apply via Terraform or AWS CLI)
# Save as JSON and create IAM policy:
# aws iam create-policy --policy-name screenshot-algo-secrets-access --policy-document file://policy.json
#
# {
#   "Version": "2012-10-17",
#   "Statement": [
#     {
#       "Effect": "Allow",
#       "Action": [
#         "secretsmanager:GetSecretValue",
#         "secretsmanager:DescribeSecret"
#       ],
#       "Resource": "arn:aws:secretsmanager:eu-central-1:*:secret:screenshot-algo/*"
#     }
#   ]
# }
