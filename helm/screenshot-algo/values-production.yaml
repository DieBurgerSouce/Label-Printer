# Production values for screenshot-algo
# Override default values for production deployment

# =============================================================================
# Replica count
# =============================================================================
replicaCount: 5

# =============================================================================
# Image settings
# =============================================================================
image:
  repository: ghcr.io/screenshot-algo/screenshot-algo
  pullPolicy: Always
  tag: "1.0.0"  # Pin to specific version in production

# =============================================================================
# Resource settings (higher for production)
# =============================================================================
resources:
  limits:
    cpu: "4"
    memory: 4Gi
  requests:
    cpu: 500m
    memory: 1Gi

# =============================================================================
# Autoscaling (more aggressive for production)
# =============================================================================
autoscaling:
  enabled: true
  minReplicas: 5
  maxReplicas: 50
  targetCPUUtilizationPercentage: 60
  targetMemoryUtilizationPercentage: 70
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 600
      policies:
        - type: Percent
          value: 5
          periodSeconds: 120
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
        - type: Percent
          value: 50
          periodSeconds: 30

# =============================================================================
# Pod Disruption Budget (stricter for production)
# =============================================================================
podDisruptionBudget:
  enabled: true
  minAvailable: 3

# =============================================================================
# Ingress (production domains)
# =============================================================================
ingress:
  enabled: true
  className: nginx
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/rate-limit-connections: "50"
    cert-manager.io/cluster-issuer: letsencrypt-prod
    # WAF annotations (if using cloud provider WAF)
    # nginx.ingress.kubernetes.io/modsecurity-snippet: "..."
  hosts:
    - host: api.screenshot-algo.com
      paths:
        - path: /
          pathType: Prefix
    - host: screenshot-algo.com
      paths:
        - path: /api
          pathType: Prefix
  tls:
    - secretName: screenshot-algo-tls-prod
      hosts:
        - api.screenshot-algo.com
        - screenshot-algo.com

# =============================================================================
# Environment variables (production-specific)
# =============================================================================
env:
  NODE_ENV: production
  PORT: "4000"
  LOG_LEVEL: info
  LOG_FORMAT: json
  METRICS_ENABLED: "true"
  TRACING_ENABLED: "true"
  TRACING_SAMPLE_RATE: "0.1"

# =============================================================================
# Pod annotations (production monitoring)
# =============================================================================
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "4000"
  prometheus.io/path: "/metrics"
  # Datadog annotations (if using Datadog)
  # ad.datadoghq.com/screenshot-algo.logs: '[{"source":"nodejs","service":"screenshot-algo"}]'

# =============================================================================
# Node scheduling (production topology)
# =============================================================================
nodeSelector:
  node-type: application

tolerations:
  - key: "dedicated"
    operator: "Equal"
    value: "application"
    effect: "NoSchedule"

affinity:
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchLabels:
            app.kubernetes.io/name: screenshot-algo
        topologyKey: kubernetes.io/hostname
  nodeAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        preference:
          matchExpressions:
            - key: topology.kubernetes.io/zone
              operator: In
              values:
                - eu-central-1a
                - eu-central-1b
                - eu-central-1c

topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: topology.kubernetes.io/zone
    whenUnsatisfiable: DoNotSchedule
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: screenshot-algo
  - maxSkew: 2
    topologyKey: kubernetes.io/hostname
    whenUnsatisfiable: DoNotSchedule
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: screenshot-algo

# =============================================================================
# Network Policy (stricter for production)
# =============================================================================
networkPolicy:
  enabled: true
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
      ports:
        - port: 4000
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
      ports:
        - port: 4000
        - port: 9090
  egress:
    # DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - port: 53
          protocol: UDP
    # Database
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: postgresql
      ports:
        - port: 5432
    # Redis
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: redis
      ports:
        - port: 6379
    # External HTTPS
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - port: 443

# =============================================================================
# Service Monitor (production intervals)
# =============================================================================
serviceMonitor:
  enabled: true
  interval: 15s
  scrapeTimeout: 10s
  labels:
    release: prometheus

# =============================================================================
# Dependencies (production sizing)
# =============================================================================
postgresql:
  enabled: true
  architecture: replication
  auth:
    database: screenshot_algo
    username: screenshot
    existingSecret: screenshot-algo-postgresql-prod
  primary:
    persistence:
      size: 100Gi
    resources:
      limits:
        cpu: "2"
        memory: 4Gi
      requests:
        cpu: 500m
        memory: 1Gi
  readReplicas:
    replicaCount: 2
    persistence:
      size: 100Gi

redis:
  enabled: true
  architecture: replication
  auth:
    enabled: true
    existingSecret: screenshot-algo-redis-prod
  master:
    persistence:
      size: 10Gi
    resources:
      limits:
        cpu: "1"
        memory: 2Gi
  replica:
    replicaCount: 2
    persistence:
      size: 10Gi
