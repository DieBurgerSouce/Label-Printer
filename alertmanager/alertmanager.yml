# AlertManager Configuration
# Email-based alerting for Screenshot_Algo monitoring

global:
  # SMTP configuration for email alerts
  smtp_smarthost: '${SMTP_HOST:-smtp.example.com}:${SMTP_PORT:-587}'
  smtp_from: '${SMTP_FROM:-alerts@screenshot-algo.local}'
  smtp_auth_username: '${SMTP_USER:-}'
  smtp_auth_password: '${SMTP_PASSWORD:-}'
  smtp_require_tls: true

  # Default resolve timeout
  resolve_timeout: 5m

# Route configuration
route:
  # Default receiver for all alerts
  receiver: 'email-alerts'

  # Group alerts by alertname and severity
  group_by: ['alertname', 'severity']

  # Wait 30 seconds to collect more alerts before sending
  group_wait: 30s

  # Wait 5 minutes before sending updates
  group_interval: 5m

  # Wait 4 hours before resending same alert
  repeat_interval: 4h

  # Child routes for specific alert types
  routes:
    # Critical alerts - send immediately
    - match:
        severity: critical
      receiver: 'email-critical'
      group_wait: 10s
      repeat_interval: 1h
      continue: true

    # Warning alerts
    - match:
        severity: warning
      receiver: 'email-alerts'
      repeat_interval: 8h

    # Info alerts - less frequent
    - match:
        severity: info
      receiver: 'email-alerts'
      repeat_interval: 24h

# Inhibition rules - suppress lower priority alerts
inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']

  - source_match:
      severity: 'warning'
    target_match:
      severity: 'info'
    equal: ['alertname', 'instance']

# Receivers configuration
receivers:
  # Default email receiver
  - name: 'email-alerts'
    email_configs:
      - to: '${ALERT_EMAIL:-admin@screenshot-algo.local}'
        send_resolved: true
        headers:
          Subject: '[Screenshot-Algo] {{ .Status | toUpper }} - {{ .CommonLabels.alertname }}'
        html: |
          <!DOCTYPE html>
          <html>
          <head>
            <style>
              body { font-family: Arial, sans-serif; margin: 20px; }
              .alert { padding: 15px; margin: 10px 0; border-radius: 5px; }
              .critical { background-color: #f8d7da; border: 1px solid #f5c6cb; }
              .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; }
              .info { background-color: #d1ecf1; border: 1px solid #bee5eb; }
              .resolved { background-color: #d4edda; border: 1px solid #c3e6cb; }
              h2 { margin-top: 0; }
              table { border-collapse: collapse; width: 100%; }
              th, td { text-align: left; padding: 8px; border-bottom: 1px solid #ddd; }
            </style>
          </head>
          <body>
            <h1>Screenshot-Algo Alert Notification</h1>
            <p><strong>Status:</strong> {{ .Status | toUpper }}</p>
            <p><strong>Alerts:</strong> {{ .Alerts | len }}</p>

            {{ range .Alerts }}
            <div class="alert {{ .Labels.severity }}{{ if eq .Status "resolved" }} resolved{{ end }}">
              <h2>{{ .Labels.alertname }}</h2>
              <p><strong>Severity:</strong> {{ .Labels.severity }}</p>
              <p><strong>Description:</strong> {{ .Annotations.description }}</p>
              <p><strong>Instance:</strong> {{ .Labels.instance }}</p>
              <p><strong>Started:</strong> {{ .StartsAt }}</p>
              {{ if .EndsAt }}
              <p><strong>Ended:</strong> {{ .EndsAt }}</p>
              {{ end }}

              <h3>Labels</h3>
              <table>
                {{ range .Labels.SortedPairs }}
                <tr><th>{{ .Name }}</th><td>{{ .Value }}</td></tr>
                {{ end }}
              </table>
            </div>
            {{ end }}

            <hr>
            <p><em>This alert was generated by AlertManager for Screenshot-Algo monitoring.</em></p>
          </body>
          </html>

  # Critical alerts receiver - separate for urgency
  - name: 'email-critical'
    email_configs:
      - to: '${ALERT_EMAIL:-admin@screenshot-algo.local}'
        send_resolved: true
        headers:
          Subject: '[CRITICAL] Screenshot-Algo - {{ .CommonLabels.alertname }}'
          X-Priority: '1'
        html: |
          <!DOCTYPE html>
          <html>
          <head>
            <style>
              body { font-family: Arial, sans-serif; margin: 20px; background-color: #fff5f5; }
              .critical-banner { background-color: #dc3545; color: white; padding: 20px; text-align: center; }
              .alert { padding: 15px; margin: 10px 0; border-radius: 5px; background-color: white; border: 2px solid #dc3545; }
              h1 { margin: 0; }
              table { border-collapse: collapse; width: 100%; }
              th, td { text-align: left; padding: 8px; border-bottom: 1px solid #ddd; }
            </style>
          </head>
          <body>
            <div class="critical-banner">
              <h1>CRITICAL ALERT</h1>
              <p>Immediate attention required!</p>
            </div>

            {{ range .Alerts }}
            <div class="alert">
              <h2>{{ .Labels.alertname }}</h2>
              <p><strong>Description:</strong> {{ .Annotations.description }}</p>
              <p><strong>Summary:</strong> {{ .Annotations.summary }}</p>
              <p><strong>Instance:</strong> {{ .Labels.instance }}</p>
              <p><strong>Started:</strong> {{ .StartsAt }}</p>

              <h3>Runbook</h3>
              <p>{{ if .Annotations.runbook_url }}<a href="{{ .Annotations.runbook_url }}">View Runbook</a>{{ else }}No runbook configured{{ end }}</p>
            </div>
            {{ end }}
          </body>
          </html>

# Templates (optional - for more complex formatting)
templates: []
