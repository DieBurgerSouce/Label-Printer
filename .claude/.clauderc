# Ablage-System Claude Code Context
# Version: 2.0
# Last Updated: 2025-11-24
# Philosophy: "Feinpoliert und durchdacht"

## ğŸš€ Quick Start Reference

### Essential Commands (Use these!)
```bash
# Development
make dev              # Start full dev environment with hot reload
make test             # Run all tests
make lint             # Code quality checks
make logs             # Follow all logs

# Or use scripts directly:
./scripts/dev.sh      # Start development server
./scripts/test.sh     # Run tests
./scripts/lint.sh     # Lint code
./scripts/build.sh    # Full build pipeline
```

### Slash Commands Available
- `/quick-test` - Test current file
- `/implement-agent` - Generate full agent from skeleton
- `/debug-gpu` - Diagnose GPU problems
- `/review-pr` - Comprehensive code review
- `/ocr-benchmark` - Run OCR quality benchmarks
- `/setup-dev` - Complete dev environment setup
- `/add-feature` - Structured feature development
- `/find-doc` - Quick documentation discovery

### Service URLs (Development)
- API: http://localhost:8000
- API Docs: http://localhost:8000/docs
- MinIO Console: http://localhost:9001 (dev/devpassword)
- pgAdmin: http://localhost:5050 (dev@ablage.local/devpassword)
- Redis Commander: http://localhost:8081
- Flower (Celery): http://localhost:5555

## ğŸ“š Documentation Navigation

### Critical Documentation (READ THESE FIRST)
1. **[CLAUDE.md](../CLAUDE.md)** - Main project instructions (THIS FILE'S PARENT)
2. **[GETTING_STARTED.md](../GETTING_STARTED.md)** - Onboarding guide
3. **[KNOWLEDGE_ARCHITECTURE.md](../KNOWLEDGE_ARCHITECTURE.md)** - Documentation system

### Documentation Indexes (USE THESE TO FIND FILES)
- **[documentation_index.md](../Meta_Layer/Indexes/documentation_index.md)** - All documentation with tags
- **[code_index.md](../Meta_Layer/Indexes/code_index.md)** - All code files with status
- **[tag_system.md](../Meta_Layer/Tags/tag_system.md)** - Tag-based navigation system

### Implementation Guides
- **[agent_implementation_roadmap.md](../Static_Knowledge/Implementation_Guides/agent_implementation_roadmap.md)** - 202-hour implementation plan (4 phases)
- **[agent_implementation_patterns.md](../Static_Knowledge/Architecture/agent_implementation_patterns.md)** - How to build agents
- **[async_patterns.md](../Static_Knowledge/Patterns/async_patterns.md)** - Async/await best practices

### Troubleshooting Guides
- **[gpu_troubleshooting_guide.md](../Execution_Layer/Troubleshooting/gpu_troubleshooting_guide.md)** - GPU issues and solutions
- **[ocr_quality_troubleshooting.md](../Execution_Layer/Troubleshooting/ocr_quality_troubleshooting.md)** - OCR accuracy problems

### Architecture & Integration
- **[component_integration_map.md](../Relations/Integration_Maps/component_integration_map.md)** - System architecture overview
- **[code_review_checklist.md](../Static_Knowledge/Checklists/code_review_checklist.md)** - Review standards

## ğŸ—ï¸ Project Structure

### Directory Organization
```
Ablage_System/
â”œâ”€â”€ .claude/              # Claude Code configuration
â”‚   â”œâ”€â”€ commands/         # Custom slash commands (8 files)
â”‚   â”œâ”€â”€ Docs/            # Additional context docs
â”‚   â”œâ”€â”€ memory/          # Conversation memory
â”‚   â”œâ”€â”€ settings.json    # Claude settings (MAX_OUTPUT_TOKENS=64000)
â”‚   â””â”€â”€ .clauderc        # This file!
â”‚
â”œâ”€â”€ .vscode/             # VSCode integration
â”‚   â”œâ”€â”€ tasks.json       # 20+ predefined tasks
â”‚   â”œâ”€â”€ launch.json      # Debug configurations (11 configs)
â”‚   â”œâ”€â”€ settings.json    # Project settings (Ruff, MyPy, Python)
â”‚   â”œâ”€â”€ extensions.json  # Recommended extensions
â”‚   â””â”€â”€ python.json      # Code snippets (12 snippets)
â”‚
â”œâ”€â”€ .githooks/           # Git hooks (version controlled)
â”‚   â”œâ”€â”€ pre-commit       # Lint, format, type check, secret scan
â”‚   â””â”€â”€ pre-push         # Tests, coverage, conflict check
â”‚
â”œâ”€â”€ app/                 # Main application code
â”‚   â”œâ”€â”€ main.py          # FastAPI entry point
â”‚   â”œâ”€â”€ api/             # API routes
â”‚   â”œâ”€â”€ core/            # Core functionality
â”‚   â”œâ”€â”€ db/              # Database models/schemas
â”‚   â”œâ”€â”€ services/        # Business logic
â”‚   â”œâ”€â”€ workers/         # Celery tasks
â”‚   â””â”€â”€ utils/           # Utilities
â”‚
â”œâ”€â”€ Static_Knowledge/    # Permanent reference docs
â”‚   â”œâ”€â”€ Architecture/    # System design patterns
â”‚   â”œâ”€â”€ Patterns/        # Code patterns
â”‚   â”œâ”€â”€ Checklists/      # Quality checklists
â”‚   â””â”€â”€ Implementation_Guides/  # Step-by-step guides
â”‚
â”œâ”€â”€ Dynamic_Knowledge/   # Generated/evolving docs
â”‚   â”œâ”€â”€ Decision_Logs/   # ADRs (Architecture Decision Records)
â”‚   â””â”€â”€ Learning_Notes/  # Insights from development
â”‚
â”œâ”€â”€ Meta_Layer/          # Documentation metadata
â”‚   â”œâ”€â”€ Indexes/         # Master indexes
â”‚   â””â”€â”€ Tags/            # Tagging system
â”‚
â”œâ”€â”€ Relations/           # Cross-reference documentation
â”‚   â””â”€â”€ Integration_Maps/  # Component relationships
â”‚
â”œâ”€â”€ Execution_Layer/     # Operational guides
â”‚   â””â”€â”€ Troubleshooting/ # Problem-solving guides
â”‚
â”œâ”€â”€ scripts/             # Development automation
â”‚   â”œâ”€â”€ dev.sh           # Start dev server
â”‚   â”œâ”€â”€ test.sh          # Test runner
â”‚   â”œâ”€â”€ lint.sh          # Linting
â”‚   â”œâ”€â”€ build.sh         # Build pipeline
â”‚   â”œâ”€â”€ db-reset.sh      # Database reset
â”‚   â””â”€â”€ setup-hooks.sh   # Install Git hooks
â”‚
â”œâ”€â”€ tests/               # Test suites
â”‚   â”œâ”€â”€ unit/            # Unit tests
â”‚   â”œâ”€â”€ integration/     # Integration tests
â”‚   â””â”€â”€ fixtures/        # Test data
â”‚
â”œâ”€â”€ infrastructure/      # Infrastructure as Code
â”‚   â”œâ”€â”€ docker/          # Dockerfiles
â”‚   â”œâ”€â”€ terraform/       # Infrastructure provisioning
â”‚   â””â”€â”€ ansible/         # Configuration management
â”‚
â”œâ”€â”€ docker-compose.yml       # Production stack
â”œâ”€â”€ docker-compose.dev.yml   # Development overrides
â”œâ”€â”€ Makefile                 # Quick commands (40+ targets)
â”œâ”€â”€ .dockerignore            # Docker build optimization
â””â”€â”€ requirements.txt         # Python dependencies
```

## ğŸ› ï¸ Technology Stack (CURRENT)

### Backend
- **Framework**: FastAPI 0.110+ (async/await)
- **Python**: 3.11+ (required)
- **ORM**: SQLAlchemy 2.0+ (async)
- **Database**: PostgreSQL 16
- **Cache/Queue**: Redis 7.x
- **Storage**: MinIO (S3-compatible)
- **Task Queue**: Celery 5.3+

### OCR Engines
- **DeepSeek-Janus-Pro 1.0**: Multimodal, best accuracy
- **GOT-OCR 2.0**: Transformer-based, 600M params
- **Surya v1.1 + Docling v1.0**: Layout-aware pipeline

### Development Tools
- **Linting**: Ruff (replaces Black + isort + flake8)
- **Type Checking**: MyPy --strict
- **Testing**: pytest + pytest-asyncio + pytest-cov
- **Containerization**: Docker 24.x, Docker Compose
- **GPU**: NVIDIA RTX 4080 (16GB VRAM, CUDA 12.x)

### Frontend (TBD)
- Framework: Vue.js or React (to be confirmed)
- Display Modes: Dark, Light, Whitescreen, Blackscreen

## ğŸ¯ Development Workflow

### Step-by-Step for New Features
1. **Find Documentation**: Use `/find-doc` or search indexes
2. **Plan**: Check [component_integration_map.md](../Relations/Integration_Maps/component_integration_map.md)
3. **Branch**: `git checkout -b feature/TICKET-123-description`
4. **Develop**:
   - Use VSCode snippets (`agent`, `router`, `test`)
   - Follow [async_patterns.md](../Static_Knowledge/Patterns/async_patterns.md)
   - Run `make lint` frequently
5. **Test**:
   - `make test` or `/quick-test`
   - Minimum 80% coverage required
6. **Review**:
   - `/review-pr` for self-review
   - Use [code_review_checklist.md](../Static_Knowledge/Checklists/code_review_checklist.md)
7. **Commit**:
   - Git hooks run automatically (lint, type check, secret scan)
   - Use Conventional Commits: `feat(ocr): add DeepSeek backend`
8. **Push**:
   - Git hooks run tests before push
   - Create PR on GitHub

### VSCode Keyboard Shortcuts
- `Ctrl+Shift+B`: Run build task (default: Build All)
- `Ctrl+Shift+T`: Run test task (default: Run Tests)
- `F5`: Start debugging (see launch.json configs)
- `Ctrl+Shift+P` â†’ "Tasks: Run Task": Access all 20+ tasks

### Common Development Tasks

#### Start Development
```bash
# Option 1: Using Makefile (recommended)
make dev              # Starts all services with hot reload

# Option 2: Using script
./scripts/dev.sh

# Option 3: Manual Docker
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d
```

#### Run Tests
```bash
# All tests
make test
# or
./scripts/test.sh

# With coverage
make test-cov
# or
./scripts/test.sh --coverage

# Only GPU tests
make test-gpu
# or
./scripts/test.sh --gpu

# Only unit tests (fast)
./scripts/test.sh --unit
```

#### Code Quality
```bash
# Check code quality
make lint
# or
./scripts/lint.sh

# Auto-fix issues
make lint-fix
# or
./scripts/lint.sh --fix

# Format code
make format
```

#### Database Operations
```bash
# Run migrations
make db-migrate

# Create new migration
make db-migrate-create MSG="add user table"

# Reset database (WARNING: destroys data)
make db-reset
# or
./scripts/db-reset.sh

# Open database shell
make db-shell

# Backup database
make db-backup
```

## ğŸ” Finding Information Quickly

### Using Tag-Based Search
```bash
# Find all GPU-related docs
grep "#gpu" Meta_Layer/Indexes/documentation_index.md

# Find all critical code files
grep "#critical" Meta_Layer/Indexes/code_index.md

# Find all developer guides
grep "#developer" Meta_Layer/Indexes/documentation_index.md
```

### Common Search Patterns
```bash
# Find all agent implementations
find app/ -name "*agent*.py"

# Find all tests for a module
find tests/ -name "test_ocr*.py"

# Search for specific function
grep -r "def process_document" app/
```

### Using Slash Commands
- **Documentation**: `/find-doc` â†’ Ask "GPU problems" â†’ Get gpu_troubleshooting_guide.md
- **Agent creation**: `/implement-agent` â†’ Generates complete agent with tests
- **Debugging**: `/debug-gpu` â†’ Runs diagnostics and suggests solutions

## ğŸš¨ Critical Rules (NEVER DO THIS)

### Security (ABSOLUTE REQUIREMENTS)
- âŒ **NEVER** log sensitive document content, API keys, or PII
- âŒ **NEVER** commit secrets to Git (.env, credentials.json)
- âŒ **NEVER** use hardcoded passwords or API keys
- âŒ **NEVER** skip input validation for user data
- âŒ **NEVER** disable HTTPS in production

### Code Quality (MANDATORY)
- âŒ **NEVER** use `Any` type in Python (use proper type hints)
- âŒ **NEVER** commit code without passing tests
- âŒ **NEVER** skip pre-commit hooks with --no-verify (unless emergency)
- âŒ **NEVER** use `print()` for logging (use structlog)
- âŒ **NEVER** create TODO comments without tickets

### GPU Management (CRITICAL)
- âŒ **NEVER** exceed 85% VRAM usage (13.6GB on RTX 4080)
- âŒ **NEVER** forget to call `torch.cuda.empty_cache()` after processing
- âŒ **NEVER** use synchronous blocking calls in async code
- âŒ **NEVER** process batches without memory checks

### German Language (REQUIRED)
- âŒ **NEVER** use English for user-facing messages
- âŒ **NEVER** forget UTF-8 encoding (Ã¤, Ã¶, Ã¼, ÃŸ must work)
- âŒ **NEVER** ignore umlaut accuracy in OCR (<95% is failure)

### On-Premises Deployment (MANDATORY)
- âŒ **NEVER** use cloud services (AWS, GCP, Azure)
- âŒ **NEVER** send data outside local infrastructure
- âŒ **NEVER** use SaaS logging services

## ğŸ“ Coding Standards

### Python Style (PEP 8 + Project Enhancements)

#### Type Hints (MANDATORY)
```python
# âœ… CORRECT: Full type annotations
from typing import Optional, List, Dict
import asyncio

async def process_document(
    document_id: str,
    ocr_backend: str = "deepseek",
    enable_cache: bool = True
) -> Dict[str, any]:
    """Process document with specified OCR backend.

    Args:
        document_id: Unique document identifier
        ocr_backend: OCR engine to use
        enable_cache: Whether to cache results

    Returns:
        Dictionary with extracted text and metadata

    Raises:
        DocumentNotFoundError: If document doesn't exist
    """
    pass

# âŒ WRONG: Missing type hints
async def process_document(document_id, ocr_backend="deepseek"):
    pass
```

#### Logging (Structured with Context)
```python
import structlog

logger = structlog.get_logger(__name__)

# âœ… CORRECT: Structured logging with context
logger.info(
    "ocr_processing_started",
    document_id=doc_id,
    backend=backend_name,
    file_size_mb=file_size / 1024 / 1024,
    gpu_available=torch.cuda.is_available()
)

# âŒ WRONG: String concatenation or f-strings
logger.info(f"Processing document {doc_id} with {backend_name}")
```

#### Error Handling
```python
# âœ… CORRECT: Specific exceptions with context
from app.core.exceptions import OCRProcessingError, GPUOutOfMemoryError

try:
    result = await ocr_service.process(image)
except torch.cuda.OutOfMemoryError as e:
    logger.error(f"GPU OOM processing document {doc_id}", exc_info=True)
    raise GPUOutOfMemoryError(f"Insufficient GPU memory for {doc_id}") from e
except Exception as e:
    logger.exception(f"Unexpected error processing {doc_id}")
    raise OCRProcessingError(f"Failed to process {doc_id}") from e

# âŒ WRONG: Bare except or generic exceptions
try:
    result = ocr_service.process(image)
except:
    print("Error occurred")
```

### Testing Standards

#### Test Structure (AAA Pattern)
```python
import pytest

@pytest.mark.asyncio
async def test_ocr_processes_document_successfully():
    """OCR sollte Dokument erfolgreich verarbeiten."""  # German description
    # Arrange
    document = create_test_document()
    ocr_service = OCRService()

    # Act
    result = await ocr_service.process(document)

    # Assert
    assert result.success is True
    assert result.text is not None
    assert len(result.text) > 0
```

#### Coverage Requirements
- **Minimum**: 80% overall
- **Critical paths**: 95%+ (OCR pipeline, authentication, data persistence)
- **New code**: 100% coverage required before merge

### Git Commit Convention
```bash
# Format: <type>(<scope>): <description>
#
# Types: feat, fix, docs, style, refactor, test, chore
# Scope: ocr, api, db, gpu, frontend, infra

# Examples:
feat(ocr): add DeepSeek-Janus-Pro backend integration
fix(api): prevent race condition in document upload
docs(readme): update deployment instructions
test(ocr): add GPU memory stress tests
refactor(db): migrate to async SQLAlchemy
chore(deps): upgrade FastAPI to 0.110.0
```

## ğŸ³ Docker Development

### Quick Reference
```bash
# Start dev environment
make dev                    # Full stack with hot reload

# View logs
make logs                   # All services
make logs-backend           # Backend only
make logs-worker            # Worker only

# Shell access
make shell-backend          # Backend container bash
make shell-worker           # Worker container bash
make shell-redis            # Redis CLI

# Rebuild
make dev-build              # Rebuild and start
make recreate               # Complete recreation

# Cleanup
make clean                  # Remove containers, volumes, cache
make clean-volumes          # Remove volumes (destroys data!)
```

### Debug in Docker
Debugpy is configured on ports:
- Backend: `localhost:5678`
- Worker: `localhost:5679`

VSCode launch configurations available:
- "Attach to Container: Backend"
- "Attach to Container: Worker"

## ğŸ¨ Display Modes (Frontend)

All UI components MUST support:
1. **Dark Mode** (default): #1a1a1a bg, #e0e0e0 text
2. **Light Mode**: #ffffff bg, #1a1a1a text
3. **Whitescreen** (High Contrast): #ffffff bg, #000000 text, WCAG AAA
4. **Blackscreen** (Inverted): #000000 bg, #ffffff text, #00ff00 accents

## ğŸ”’ Security Checklist

Before ANY commit:
- [ ] No secrets in code (use .env)
- [ ] No PII in logs
- [ ] Input validation present
- [ ] SQL injection prevented (use parameterized queries)
- [ ] XSS prevented (sanitize user input)
- [ ] CSRF protection enabled
- [ ] Rate limiting configured
- [ ] Authentication required for sensitive endpoints

## ğŸ“Š Performance Targets

### Response Time (95th percentile)
- API Health Check: < 50ms
- Document Upload: < 500ms
- OCR Processing (single page): < 2s (GPU), < 10s (CPU)
- Document Retrieval: < 100ms (cached), < 300ms (DB)
- Search Query: < 500ms

### Throughput
- Concurrent Users: 100+
- Documents per Hour: 500+ (GPU), 100+ (CPU)
- API Requests per Second: 1000+

### Resource Limits
- Max Document Size: 50 MB
- Max Batch Size: 32 documents (GPU), 8 (CPU)
- Database Connection Pool: 20 connections
- Redis Max Memory: 2 GB

## ğŸ§ª Testing Strategy

### Test Types
```bash
# Unit tests (fast, no external dependencies)
pytest -m "not integration and not gpu"

# Integration tests (database, Redis, MinIO)
pytest -m integration

# GPU tests (requires RTX 4080)
pytest -m gpu

# All tests with coverage
pytest --cov=app --cov-report=html --cov-report=term
```

### Test Markers
- `@pytest.mark.unit`: Unit test
- `@pytest.mark.integration`: Integration test
- `@pytest.mark.gpu`: Requires GPU
- `@pytest.mark.slow`: Long-running test
- `@pytest.mark.asyncio`: Async test

## ğŸš€ Deployment

### Environment-Specific Configuration
```bash
# Development
ENV=development make dev

# Staging
ENV=staging docker-compose up -d

# Production
ENV=production docker-compose up -d
```

### Infrastructure as Code
```bash
# Terraform (infrastructure provisioning)
cd infrastructure/terraform
terraform plan -out=tfplan
terraform apply tfplan

# Ansible (configuration management)
cd infrastructure/ansible
ansible-playbook -i inventory/production playbooks/deploy.yml
```

## ğŸ› Debugging Tips

### GPU Issues
```bash
# Check GPU status
nvidia-smi
# or
make gpu-status

# Monitor GPU real-time
watch -n 1 nvidia-smi
# or
make gpu-logs

# Test GPU in container
make gpu-test
```

### Application Issues
```bash
# Check service health
make health

# View all service URLs
make urls

# Follow specific service logs
make logs-backend
make logs-worker
make logs-db
```

### Database Issues
```bash
# Open database shell
make db-shell

# Check connections
docker exec ablage-postgres-dev psql -U postgres -d ablage_ocr -c "SELECT * FROM pg_stat_activity;"

# View slow queries
docker exec ablage-postgres-dev psql -U postgres -d ablage_ocr -c "SELECT * FROM pg_stat_statements ORDER BY mean_time DESC LIMIT 10;"
```

## ğŸ“š Learning Resources

### Internal Documentation
- All guides in `Static_Knowledge/`
- Troubleshooting in `Execution_Layer/Troubleshooting/`
- Architecture in `Relations/Integration_Maps/`

### External Resources
- FastAPI: https://fastapi.tiangolo.com/
- SQLAlchemy 2.0: https://docs.sqlalchemy.org/en/20/
- Celery: https://docs.celeryq.dev/
- PostgreSQL: https://www.postgresql.org/docs/16/
- MinIO: https://min.io/docs/
- Ruff: https://docs.astral.sh/ruff/

## ğŸ¯ Current Project Status

### Completed (Phase 0 & 1)
- [x] Basic project structure
- [x] Core documentation (12,000+ lines)
- [x] Tag-based navigation system
- [x] Custom slash commands (8 commands)
- [x] Development scripts (5 scripts)
- [x] VSCode integration (tasks, debug, snippets)
- [x] Git hooks (pre-commit, pre-push)
- [x] Docker development setup
- [x] Makefile with 40+ commands

### In Progress
- [ ] Agent implementation (Phase 1: Core Agents)
- [ ] OCR backend integration
- [ ] Frontend development
- [ ] Testing infrastructure

### Upcoming (Phase 2-4)
- [ ] Advanced features
- [ ] Production deployment
- [ ] Monitoring and observability
- [ ] Performance optimization

See [agent_implementation_roadmap.md](../Static_Knowledge/Implementation_Guides/agent_implementation_roadmap.md) for full 202-hour plan.

## ğŸ†˜ Getting Help

### Documentation Search
1. Use `/find-doc` slash command
2. Search tag system: `grep "#yourtag" Meta_Layer/Indexes/documentation_index.md`
3. Check indexes: documentation_index.md, code_index.md
4. Read troubleshooting guides in `Execution_Layer/Troubleshooting/`

### Common Questions
- **"How do I implement an agent?"** â†’ `/implement-agent` or read [agent_implementation_patterns.md](../Static_Knowledge/Architecture/agent_implementation_patterns.md)
- **"GPU not working?"** â†’ `/debug-gpu` or read [gpu_troubleshooting_guide.md](../Execution_Layer/Troubleshooting/gpu_troubleshooting_guide.md)
- **"OCR quality issues?"** â†’ Read [ocr_quality_troubleshooting.md](../Execution_Layer/Troubleshooting/ocr_quality_troubleshooting.md)
- **"Code review?"** â†’ `/review-pr` or read [code_review_checklist.md](../Static_Knowledge/Checklists/code_review_checklist.md)

---

**Remember**: This is an enterprise-grade system requiring production-ready code. Every line matters. Every test counts. Security is paramount. German language accuracy is non-negotiable. GPU efficiency is critical.

**Philosophy**: "Feinpoliert und durchdacht" - Polished and well-thought-out.
