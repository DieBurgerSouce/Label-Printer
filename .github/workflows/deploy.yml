# Deployment Workflow
# Production and staging deployments

name: Deploy

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

concurrency:
  group: deploy-${{ github.event.inputs.environment || 'staging' }}
  cancel-in-progress: false

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build application
        run: npm run build

      - name: Extract metadata
        id: meta
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

  deploy-staging:
    name: Deploy to Staging
    needs: build
    runs-on: ubuntu-latest
    if: github.event.inputs.environment != 'production'
    environment:
      name: staging
      url: https://staging.example.com

    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Staging
        run: |
          echo "Deploying to staging..."
          echo "Image tag: ${{ needs.build.outputs.image_tag }}"
          # Add your deployment commands here
          # Example: kubectl set image deployment/app app=$IMAGE_TAG

      - name: Run database migrations
        run: |
          echo "Running migrations..."
          # npx prisma migrate deploy

      - name: Wait for deployment
        run: |
          echo "Waiting for deployment to complete..."
          sleep 30

      - name: Run smoke tests
        run: |
          echo "Running smoke tests against staging..."
          # Wait for service to be ready
          for i in {1..30}; do
            if curl -sf --max-time 10 "$STAGING_URL/health/ready" > /dev/null 2>&1; then
              echo "âœ… Service is healthy!"
              exit 0
            fi
            echo "Attempt $i/30 - waiting..."
            sleep 10
          done
          echo "âŒ Health check failed after 30 attempts"
          exit 1
        env:
          STAGING_URL: https://staging.example.com

      - name: Notify on success
        if: success()
        run: |
          echo "## Staging Deployment Successful ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.build.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://staging.example.com" >> $GITHUB_STEP_SUMMARY

  deploy-production:
    name: Deploy to Production
    needs: [build, deploy-staging]
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'production' || startsWith(github.ref, 'refs/tags/')
    environment:
      name: production
      url: https://example.com

    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Production
        run: |
          echo "Deploying to production..."
          echo "Image tag: ${{ needs.build.outputs.image_tag }}"
          # Add your deployment commands here

      - name: Run database migrations
        run: |
          echo "Running production migrations..."
          # npx prisma migrate deploy

      - name: Wait for deployment
        run: |
          echo "Waiting for deployment to complete..."
          sleep 60

      - name: Run smoke tests
        run: |
          echo "Running smoke tests against production..."
          # Wait for service to be ready
          for i in {1..30}; do
            if curl -sf --max-time 10 "$PROD_URL/health/ready" > /dev/null 2>&1; then
              echo "âœ… Service is healthy!"
              exit 0
            fi
            echo "Attempt $i/30 - waiting..."
            sleep 10
          done
          echo "âŒ Health check failed after 30 attempts"
          exit 1
        env:
          PROD_URL: https://example.com

      - name: Notify on success
        if: success()
        run: |
          echo "## Production Deployment Successful ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.build.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://example.com" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "## âš ï¸ Production Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs and consider rollback." >> $GITHUB_STEP_SUMMARY

  rollback:
    name: Rollback (Manual)
    runs-on: ubuntu-latest
    if: failure() && github.event.inputs.environment == 'production'
    needs: deploy-production
    environment:
      name: production-rollback

    steps:
      - name: Rollback deployment
        run: |
          echo "Rolling back to previous version..."
          # Add rollback commands here
          # Example: kubectl rollout undo deployment/app
