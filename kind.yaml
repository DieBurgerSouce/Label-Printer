# Kind (Kubernetes IN Docker) Configuration
# Documentation: https://kind.sigs.k8s.io/docs/user/configuration/

kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4

name: screenshot-algo-dev

# Node configuration
nodes:
  # Control plane node
  - role: control-plane
    kubeadmConfigPatches:
      - |
        kind: InitConfiguration
        nodeRegistration:
          kubeletExtraArgs:
            node-labels: "ingress-ready=true"
    extraPortMappings:
      # HTTP
      - containerPort: 80
        hostPort: 80
        protocol: TCP
      # HTTPS
      - containerPort: 443
        hostPort: 443
        protocol: TCP
      # NodePort range for services
      - containerPort: 30000
        hostPort: 30000
        protocol: TCP
      - containerPort: 30001
        hostPort: 30001
        protocol: TCP
      - containerPort: 30002
        hostPort: 30002
        protocol: TCP
    extraMounts:
      # Mount local screenshots directory for persistence
      - hostPath: ./data/screenshots
        containerPath: /data/screenshots
      # Mount local config
      - hostPath: ./config
        containerPath: /config

  # Worker nodes (add more for multi-node testing)
  - role: worker
    extraMounts:
      - hostPath: ./data/screenshots
        containerPath: /data/screenshots

  - role: worker
    extraMounts:
      - hostPath: ./data/screenshots
        containerPath: /data/screenshots

# Networking configuration
networking:
  # Use default CNI (kindnet)
  disableDefaultCNI: false
  # Pod subnet
  podSubnet: "10.244.0.0/16"
  # Service subnet
  serviceSubnet: "10.96.0.0/12"
  # API server address
  apiServerAddress: "127.0.0.1"
  # API server port
  apiServerPort: 6443

# Feature gates
featureGates:
  # Enable useful features for development
  "EphemeralContainers": true

# Container runtime patches
containerdConfigPatches:
  - |-
    [plugins."io.containerd.grpc.v1.cri".registry.mirrors."localhost:5000"]
      endpoint = ["http://kind-registry:5000"]

---
# Usage Instructions:
#
# 1. Create cluster:
#    kind create cluster --config kind.yaml
#
# 2. Verify cluster:
#    kubectl cluster-info --context kind-screenshot-algo-dev
#
# 3. Install ingress controller:
#    kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
#
# 4. Wait for ingress to be ready:
#    kubectl wait --namespace ingress-nginx \
#      --for=condition=ready pod \
#      --selector=app.kubernetes.io/component=controller \
#      --timeout=90s
#
# 5. Deploy application:
#    kubectl apply -k k8s/overlays/dev
#
# 6. Access application:
#    curl http://localhost/health
#
# 7. Delete cluster when done:
#    kind delete cluster --name screenshot-algo-dev
#
# Tips:
# - Use `kind load docker-image <image>` to load local images
# - Use `docker exec -it screenshot-algo-dev-control-plane bash` to access node
# - Use `kubectl logs -f -n screenshot-algo <pod>` to view logs
